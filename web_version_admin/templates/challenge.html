<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ challenge.name }} - CCRI CTF Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background: #f9f9f9;
        }
        h1 {
            color: #333;
        }
        .actions {
            margin: 15px 0;
        }
        .actions button {
            margin-right: 10px;
        }
        .environment-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .readme {
            background: #f1f1f1;
            padding: 15px;
            border-radius: 6px;
            white-space: normal;
            word-wrap: break-word;
        }
        .readme h1, .readme h2, .readme h3 {
            margin-top: 15px;
            color: #222;
        }
        .readme p {
            margin: 10px 0;
        }
        .readme code {
            background: #eaeaea;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        .readme pre {
            background: #eaeaea;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .readme ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .readme strong {
            font-weight: bold;
        }
        #flagInput {
            width: 300px;
            padding: 5px;
            margin-top: 5px;
        }
        #flagStatus {
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>{{ challenge.name }}</h1>

    <div class="actions">
        <button onclick="runScript()">üñ• Run Helper Script</button>
        <button onclick="openFolder()">üìÇ Open Folder</button>
        <button onclick="location.href='/'">‚¨Ö Back to Challenges</button>
    </div>

    <div id="environmentInfo" class="environment-info" style="display: none;">
        <!-- Will be populated by JavaScript -->
    </div>

    <hr>

    <h2>üìñ Challenge Details</h2>
    {% if readme %}
    <div class="readme">
        {{ readme|safe }}
    </div>
    {% else %}
    <p><em>No README.txt found in this folder.</em></p>
    {% endif %}

    <h2>üìÇ Attached Files</h2>
    {% if files %}
    <ul>
        {% for file in files %}
        <li>
            <a href="{{ url_for('static', filename='../' + challenge.folder + '/' + file) }}" target="_blank">{{ file }}</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p><em>No additional files in this folder.</em></p>
    {% endif %}

    <h2>üèÅ Submit Flag</h2>
    <input type="text" id="flagInput" placeholder="Enter flag (CCRI-XXXX-1234)">
    <button onclick="submitFlag()">‚úÖ Submit</button>
    <p id="flagStatus"></p>

    <script>
        let environmentInfo = null;

        // Load environment info on page load
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch('/api/environment');
                environmentInfo = await response.json();

                if (environmentInfo.in_docker) {
                    const envDiv = document.getElementById('environmentInfo');
                    envDiv.innerHTML = `
                        <strong>üê≥ Running in Docker</strong><br>
                        Script output will appear in browser. Use <code>docker-compose logs -f</code> to see detailed logs.
                    `;
                    envDiv.style.display = 'block';
                }
            } catch (e) {
                console.log('Could not load environment info');
            }

            // Restore saved flag
            const savedFlag = localStorage.getItem("{{ challenge_id }}");
            if (savedFlag) {
                const flagInput = document.getElementById('flagInput');
                flagInput.value = savedFlag;
                const status = document.getElementById('flagStatus');
                status.textContent = "üéâ Correct flag!";
                status.style.color = "green";
            }
        });

        function runScript() {
            const status = document.getElementById('flagStatus');
            status.textContent = "üîÑ Running script...";
            status.style.color = "blue";

            fetch(`/run_script/{{ challenge_id }}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        if (environmentInfo && environmentInfo.in_docker && data.message) {
                            status.textContent = "‚úÖ " + data.message;
                            status.style.color = "green";
                        } else {
                            status.textContent = "‚úÖ Script launched successfully";
                            status.style.color = "green";
                        }
                    } else if (data.status === "info") {
                        status.textContent = "‚ÑπÔ∏è " + data.message;
                        status.style.color = "blue";
                    } else {
                        status.textContent = "‚ùå " + (data.message || "Failed to run script");
                        status.style.color = "red";
                    }
                })
                .catch(err => {
                    status.textContent = "‚ùå Error running script";
                    status.style.color = "red";
                    console.error("Script error:", err);
                });
        }

        function openFolder() {
            fetch(`/open_folder/{{ challenge_id }}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    const status = document.getElementById('flagStatus');
                    if (data.status === "success") {
                        status.textContent = "‚úÖ Folder opened";
                        status.style.color = "green";
                    } else if (data.status === "info") {
                        status.textContent = "‚ÑπÔ∏è " + data.message;
                        status.style.color = "blue";
                    } else {
                        status.textContent = "‚ùå " + (data.message || "Failed to open folder");
                        status.style.color = "red";
                    }
                })
                .catch(err => {
                    console.error("Folder error:", err);
                });
        }

        function submitFlag() {
            const flag = document.getElementById('flagInput').value.trim().toUpperCase();
            fetch(`/submit_flag/{{ challenge_id }}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ flag: flag })
            })
            .then(res => res.json())
            .then(data => {
                const status = document.getElementById('flagStatus');
                if (data.status === "correct") {
                    status.textContent = "üéâ Correct flag!";
                    status.style.color = "green";
                    localStorage.setItem("{{ challenge_id }}", flag);
                } else if (data.status === "incorrect") {
                    status.textContent = "‚ùå Incorrect flag.";
                    status.style.color = "red";
                } else {
                    status.textContent = "‚ö†Ô∏è Error: " + data.message;
                    status.style.color = "orange";
                }
            });
        }
    </script>
</body>
</html>